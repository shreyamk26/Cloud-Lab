<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@latest/dist/keycloak.min.js"></script>
</head>
<body>
  <h1>Keycloak Protected App</h1>
  <button onclick="keycloak.login()">Login</button>
  <button onclick="keycloak.logout()">Logout</button>
  <button onclick="showToken()">Show Token</button>
  <button onclick="validateToken()">Validate Token</button>

  <div id="output"></div>

  <script>
    const keycloak = new Keycloak({
      url: 'http://localhost:8080/auth',
      realm: 'secured-apps',
      clientId: 'html-clientss' 
    });

    keycloak.init({
      onLoad: 'login-required',
      checkLoginIframe: true 
    }).then(authenticated => {
      document.getElementById('output').innerHTML = authenticated ? "Authenticated <br>" : "Not Authenticated <br>";

      setInterval(() => { 
        keycloak.updateToken(30).catch(() => {
          alert("Token expired or invalid. Logging out...");
          keycloak.logout();
        });
      }, 1000);
    }).catch(err => {
      document.getElementById('output').innerHTML = "<p style='color:red;'>Keycloak init failed: " + err + "</p>";
    });

    function showToken() {
      document.getElementById('output').innerHTML +=
        "<p><b>Access token:</b><br>" + keycloak.token + "</p>";
    }

    async function validateToken() {
      try {
        const response = await fetch("http://localhost:8080/auth/realms/secured-apps/protocol/openid-connect/userinfo", {
          headers: {
            "Authorization": "Bearer " + keycloak.token 
          }
        });

        if (!response.ok) throw new Error("Invalid token or permission error");

        const data = await response.json();
        document.getElementById('output').innerHTML +=
          "<p>Token valid. User: " + data.preferred_username + "</p>"; 
      } catch (err) {
        document.getElementById('output').innerHTML +=
          "<p style='color:red;'>" + err.message + "</p>";
      }
    }
  </script>
</body>
</html>
